#!/usr/bin/env python
'''
Taskset Simulator and Virtual-Gang Combination Generator for RTG-Synch

The purpose of the simulator is the following: Given a candidate taskset
generate all possible virtual-gang combinations. Using a brute-force approach,
determine the virtual-gang combination which gives the smallest cumulative
execution time for the entire taskset.

The optimal solution given by the simulator can be used to evaluate heuristic
and greedy algorithm based solutions.

Copyright (C) 2019 KU-CSL
09-08-2019  Integrate combination generator with taskset simulator
'''

import sys
from tasksetGenerator import Generator
from algorithmFactory import Heuristics
from virtualGangFactory import CombinationGenerator

# All time values are in msec; unless specified otherwise
PERIOD = 1000
RTGANG_SCALING_FACTOR = 1.1
RTG_SYNCH_SCALING_FACTOR = 1.2
NUM_OF_CORES = int (sys.argv [1])

def get_rtgsynch_schedulability (taskList):
    heuristics = Heuristics ()
    virtualGangGenerator = CombinationGenerator (NUM_OF_CORES)
    gangs, computeTimes = virtualGangGenerator.generate_gang_combinations (taskList)
    bestConfig, bestCompletionTime = heuristics.rankConfigurations (gangs, computeTimes, False)
    scaledCompletionTime = bestCompletionTime * RTG_SYNCH_SCALING_FACTOR
    schedulability = min (1, round (PERIOD / scaledCompletionTime, 3))

    return schedulability

def main ():
    generator = Generator (NUM_OF_CORES, PERIOD)
    tasksetHash = {}
    tasksetHash ['light'] = generator.create_taskset ('light')
    tasksetHash ['mixed'] = generator.create_taskset ('mixed')
    tasksetHash ['heavy'] = generator.create_taskset ('heavy')

    schedulabilityHash = {'light': {}, 'mixed': {}, 'heavy': {}}

    for workloadType in schedulabilityHash:
        taskset = tasksetHash [workloadType]

        for utilization in taskset:
            schedulabilityHash [workloadType][utilization] = {}
            # schedulabilityHash [workloadType][utilization]['rtgang'] = get_rtgang_schedulability (taskset [utilization])
            schedulabilityHash [workloadType][utilization]['rtgsynch'] = get_rtgsynch_schedulability (taskset [utilization])

    print schedulabilityHash

    return

if __name__ == '__main__':
    main ()
